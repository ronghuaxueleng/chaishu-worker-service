# Worker Service 项目结构说明

## 📁 目录结构

```
worker-service/
├── worker.py                      # Worker 节点启动脚本（主入口）
├── start.sh                       # 快速启动脚本（自动检查环境）
├── requirements.txt               # Python 依赖包
├── .env.example                   # 环境变量模板
├── .gitignore                     # Git 忽略文件
├── Dockerfile                     # Docker 镜像构建文件
├── docker-compose.yml             # Docker Compose 配置
├── .dockerignore                  # Docker 构建忽略文件
├── README.md                      # 项目说明文档
│
├── src/                           # 源代码目录
│   ├── __init__.py
│   ├── services/                  # 业务服务层
│   │   ├── __init__.py
│   │   ├── kg_task_worker.py              # Worker 进程管理
│   │   ├── kg_task_queue_service.py       # Redis 队列服务
│   │   ├── knowledge_graph_extractor.py   # 知识图谱提取器
│   │   ├── knowledge_graph_service.py     # Neo4j 图谱服务
│   │   └── ai_provider_throttle.py        # Provider 限流控制
│   │
│   ├── models/                    # 数据模型层
│   │   ├── __init__.py
│   │   └── database.py                    # SQLAlchemy ORM 模型
│   │
│   ├── utils/                     # 工具模块
│   │   ├── __init__.py
│   │   └── redis_client.py                # Redis 客户端封装
│   │
│   └── config/                    # 配置模块（预留）
│       └── __init__.py
│
├── docs/                          # 文档目录
│   ├── Worker节点配置要求与部署指南.md
│   ├── Worker节点任务分配与故障恢复机制.md
│   ├── Worker分布式部署实施总结.md
│   ├── Kaggle部署Worker节点指南.md
│   ├── Docker部署指南.md
│   └── 项目结构说明.md（本文档）
│
├── scripts/                       # 脚本目录（预留）
│   └── （运维脚本）
│
└── logs/                          # 日志目录（运行时创建）
    └── worker.log
```

## 📄 核心文件说明

### 主入口文件

#### worker.py
Worker 节点启动脚本，功能包括：
- 打印启动横幅
- 验证环境变量
- 导入 Worker 模块
- 启动多进程 Worker
- 优雅停止处理

**使用方式**:
```bash
python worker.py
```

#### start.sh
自动化启动脚本，功能包括：
- 检查 Python 环境
- 检查并创建 .env 配置
- 自动创建虚拟环境
- 安装依赖包
- 启动 Worker

**使用方式**:
```bash
./start.sh
```

### 配置文件

#### .env.example
环境变量配置模板，包含：
- Redis 连接配置
- MySQL 连接配置
- Neo4j 连接配置
- Worker 运行参数

**使用步骤**:
1. 复制为 `.env`: `cp .env.example .env`
2. 编辑 `.env` 填写实际配置
3. Worker 会自动加载 `.env` 文件

#### requirements.txt
Python 依赖包列表：
- `SQLAlchemy==2.0.21` - ORM 数据库访问
- `PyMySQL==1.1.0` - MySQL 驱动
- `neo4j>=5.28.0` - Neo4j Python 驱动
- `redis>=5.0.0` - Redis 客户端
- `httpx==0.25.0` - 异步 HTTP 客户端
- `python-dotenv==1.0.0` - 环境变量加载

### Docker 文件

#### Dockerfile
Docker 镜像构建定义：
- 基于 `python:3.10-slim`
- 安装系统依赖（gcc）
- 安装 Python 依赖
- 创建日志目录
- 健康检查配置

**构建命令**:
```bash
docker build -t kg-worker:latest .
```

#### docker-compose.yml
Docker Compose 服务编排：
- 自动重启策略
- 环境变量注入
- 日志持久化
- 资源限制配置

**使用命令**:
```bash
docker-compose up -d      # 启动
docker-compose logs -f    # 查看日志
docker-compose down       # 停止
```

## 🔧 核心模块说明

### src/services/

#### kg_task_worker.py
Worker 进程管理器，核心功能：
- **多进程启动**: 按 Provider 创建进程池
- **任务消费**: 从 Redis 队列拉取任务
- **执行控制**: 调用知识图谱提取器
- **进程保护**: 防止进程数爆炸
- **优雅停止**: 等待任务完成后退出

**关键函数**:
- `start_kg_task_workers()` - 启动 Worker 进程
- `kg_task_worker_process()` - Worker 进程主循环
- `stop_all_workers()` - 停止所有 Worker
- `get_worker_stats()` - 获取进程统计

#### kg_task_queue_service.py
Redis 队列服务，核心功能：
- **任务入队**: 将任务推送到 Provider 队列
- **任务出队**: 使用 BRPOP 原子拉取
- **队列查询**: 获取队列长度
- **任务追踪**: 记录正在处理的任务

**Redis 队列命名**:
```
kg:task:queue:{provider}           # 任务队列
kg:task:processing:{task_id}       # 处理中标记
kg:worker:active                   # 活跃 Worker 集合
```

#### knowledge_graph_extractor.py
知识图谱提取器，核心功能：
- **章节分析**: 调用 AI 提取实体和关系
- **实体识别**: 识别角色、事件、地点等
- **关系提取**: 提取实体间关系
- **Neo4j 写入**: 创建节点和关系
- **错误恢复**: 处理失败章节

#### knowledge_graph_service.py
Neo4j 图谱服务，核心功能：
- **连接管理**: Neo4j Driver 连接池
- **节点创建**: 创建 Character/Event/Location 节点
- **关系创建**: 创建各类关系边
- **查询统计**: 图谱数据统计
- **约束管理**: 创建索引和约束

#### ai_provider_throttle.py
Provider 限流控制，核心功能：
- **暂停机制**: 暂停失败过多的 Provider
- **自动恢复**: 超时后自动恢复
- **状态查询**: 查询 Provider 状态

### src/models/

#### database.py
SQLAlchemy ORM 模型定义：
- `Novel` - 小说表
- `Chapter` - 章节表
- `KnowledgeGraphTask` - 知识图谱任务表
- `AIProvider` - AI 服务商表
- `db_manager` - 数据库连接管理器

**关键类**:
```python
db_manager.get_session()      # 获取数据库会话
db_manager.close_all_connections()  # 关闭所有连接
```

### src/utils/

#### redis_client.py
Redis 客户端封装：
- **连接管理**: 单例模式连接池
- **环境变量**: 自动读取配置
- **连接测试**: 健康检查

**使用方式**:
```python
from src.utils.redis_client import get_redis_client

redis_client = get_redis_client()
redis_client.ping()
```

## 🚀 运行流程

### 启动流程

```
1. worker.py 启动
   ↓
2. 加载环境变量（.env）
   ↓
3. 验证必需配置（REDIS_HOST, DB_HOST, NEO4J_URI）
   ↓
4. 导入 Worker 模块
   ↓
5. 查询数据库获取 AI Providers
   ↓
6. 为每个 Provider 创建进程池
   ↓
7. 每个进程启动后：
   - 重置数据库连接
   - 进入消费循环
   - 从 Redis 队列拉取任务
   - 调用知识图谱提取器
   - 写入 Neo4j
   - 更新任务状态
   ↓
8. 主进程监控（Ctrl+C 停止）
   ↓
9. 优雅停止（等待任务完成）
```

### 任务执行流程

```
1. 前端创建知识图谱任务
   ↓
2. 主系统将任务推送到 Redis 队列
   队列名: kg:task:queue:{provider}
   ↓
3. Worker 进程使用 BRPOP 拉取任务
   ↓
4. 解析任务 JSON
   ↓
5. 查询数据库获取任务详情
   ↓
6. 遍历小说章节：
   - 读取章节内容
   - 调用 AI 提取实体和关系
   - 写入 Neo4j 图谱
   - 更新章节处理状态
   ↓
7. 更新任务状态为完成
   ↓
8. 继续拉取下一个任务
```

## 📊 数据流

```
┌──────────────┐
│  Frontend    │ 创建任务
└──────┬───────┘
       │
       ▼
┌──────────────┐
│  Main API    │ 推送到队列
└──────┬───────┘
       │
       ▼
┌──────────────┐
│ Redis Queue  │ kg:task:queue:{provider}
└──────┬───────┘
       │
       ▼ (BRPOP)
┌──────────────┐
│ Worker Node  │ 拉取任务
└──────┬───────┘
       │
       ├───────► MySQL (查询任务、章节)
       │
       ├───────► AI Provider (调用 API)
       │
       └───────► Neo4j (写入图谱)
```

## 🔒 安全注意事项

1. **环境变量保护**
   - `.env` 文件不要提交到 Git
   - 生产环境使用 Docker Secrets

2. **数据库连接**
   - 使用只读权限的数据库用户（如果可能）
   - 限制网络访问 IP

3. **日志敏感信息**
   - 不要记录密码
   - 不要记录完整 API 密钥

4. **进程保护**
   - `KG_MAX_TOTAL_PROCESSES` 防止进程爆炸
   - `KG_MAX_PROCESSES_PER_PROVIDER` 限制单 Provider

## 📈 性能优化建议

1. **进程数调优**
   - 根据 CPU 核心数调整
   - 根据内存容量调整
   - 监控资源使用情况

2. **网络优化**
   - Worker 节点部署在靠近 Redis/MySQL/Neo4j 的网络
   - 使用内网连接

3. **数据库连接池**
   - SQLAlchemy 连接池已配置
   - Neo4j 使用连接池

4. **批量操作**
   - Neo4j 使用批量创建节点
   - 减少网络往返

## 🆘 故障排查

### 常见问题定位

1. **Worker 无法启动**
   - 检查环境变量是否配置
   - 检查网络连接
   - 查看日志: `logs/worker.log`

2. **任务不执行**
   - 检查 Redis 队列是否有任务
   - 检查 Provider 是否暂停
   - 检查 Worker 进程是否运行

3. **内存泄漏**
   - 监控进程内存
   - 检查数据库连接是否正确关闭
   - 考虑减少进程数

4. **Neo4j 写入失败**
   - 检查 Neo4j 连接
   - 查看失败数据表
   - 使用自动重试功能

## 📚 扩展开发

### 添加新功能

1. **新增服务模块**: 在 `src/services/` 创建
2. **新增工具函数**: 在 `src/utils/` 创建
3. **修改 Worker 逻辑**: 编辑 `kg_task_worker.py`

### 自定义配置

1. 修改 `.env.example` 添加新变量
2. 在代码中使用 `os.environ.get()`
3. 更新文档说明

## 🔗 相关链接

- [主项目仓库](https://github.com/ronghuaxueleng/chaishu-vue3)
- [问题反馈](https://github.com/ronghuaxueleng/chaishu-vue3/issues)

---

**版本**: v1.0
**更新日期**: 2025-10-17
**维护者**: Claude Code
